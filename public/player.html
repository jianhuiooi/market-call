<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Market Call ‚Äî Player</title>
<script src="/socket.io/socket.io.js"></script>
<script>if (typeof io === 'undefined') { document.write('<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"><\/script>'); }</script>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Share+Tech+Mono&family=Noto+Sans+HK:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #06080f;
    --surface: #0d1120;
    --border: #1a2240;
    --jade: #00c896;
    --neon-red: #ff2d55;
    --gold: #f0a500;
    --harbour: #4d9fff;
    --text: #dde4f0;
    --muted: #4a5570;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body {
    background: var(--bg);
    background-image: radial-gradient(ellipse 80% 50% at 50% 100%, rgba(77,159,255,0.06) 0%, transparent 70%);
    color: var(--text); font-family: 'Noto Sans HK', sans-serif; min-height: 100vh; overscroll-behavior: none;
  }

  .screen { display: none; padding: 24px 20px; min-height: 100vh; }
  .screen.active { display: block; }

  /* Join */
  .join-logo { font-family: 'Bebas Neue', sans-serif; font-size: 52px; color: var(--jade); letter-spacing: 4px; margin-bottom: 2px; text-shadow: 0 0 20px rgba(0,200,150,0.4); }
  .join-logo span { color: var(--neon-red); text-shadow: 0 0 20px rgba(255,45,85,0.4); }
  .join-hk { font-family: 'Noto Sans HK', sans-serif; font-size: 13px; color: var(--neon-red); letter-spacing: 4px; margin-bottom: 32px; opacity: 0.8; }
  .input-group { margin-bottom: 16px; }
  .input-label { font-family: 'Share Tech Mono', monospace; font-size: 11px; color: var(--muted); letter-spacing: 2px; margin-bottom: 8px; display: block; }
  input[type=text] {
    width: 100%; background: var(--surface); border: 1px solid var(--border); color: var(--text);
    font-family: 'Noto Sans HK', sans-serif; font-size: 16px; padding: 14px 16px; border-radius: 4px;
    outline: none; transition: border-color 0.2s;
  }
  input[type=text]:focus { border-color: var(--jade); box-shadow: 0 0 0 2px rgba(0,200,150,0.1); }
  .btn-full {
    width: 100%; background: var(--jade); color: #000; font-family: 'Share Tech Mono', monospace;
    font-size: 14px; font-weight: 700; letter-spacing: 2px; padding: 16px; border: none; border-radius: 4px;
    cursor: pointer; margin-top: 8px; transition: all 0.2s;
  }
  .btn-full:active { transform: scale(0.98); }
  .btn-full:disabled { opacity: 0.3; }

  /* Status bar */
  .status-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .player-name { font-family: 'Share Tech Mono', monospace; font-size: 12px; color: var(--muted); letter-spacing: 1px; }
  .capital-display { font-family: 'Bebas Neue', sans-serif; font-size: 36px; color: var(--jade); text-shadow: 0 0 16px rgba(0,200,150,0.3); }
  .capital-label { font-family: 'Share Tech Mono', monospace; font-size: 10px; color: var(--muted); letter-spacing: 1px; }

  /* Wait */
  .wait-box { text-align: center; padding: 48px 20px; }
  .wait-title { font-family: 'Bebas Neue', sans-serif; font-size: 32px; color: var(--muted); margin-bottom: 16px; letter-spacing: 2px; }
  .wait-dot { display: inline-block; width: 8px; height: 8px; background: var(--jade); border-radius: 50%; margin: 0 3px; animation: bounce 1.2s ease-in-out infinite; }
  .wait-dot:nth-child(2) { animation-delay: 0.2s; }
  .wait-dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }

  /* Voting */
  .round-title { font-family: 'Bebas Neue', sans-serif; font-size: 24px; color: var(--text); margin-bottom: 4px; }
  .timer-bar-wrap { background: var(--surface); border-radius: 2px; height: 5px; margin: 10px 0 18px; overflow: hidden; }
  .timer-bar { height: 100%; background: var(--jade); border-radius: 2px; transition: width 1s linear, background 0.3s; }
  .timer-bar.urgent { background: var(--neon-red); }

  .market-section { margin-bottom: 18px; }
  .market-label { font-family: 'Share Tech Mono', monospace; font-size: 11px; color: var(--harbour); letter-spacing: 2px; margin-bottom: 8px; }
  .direction-btns { display: flex; gap: 8px; margin-bottom: 8px; }
  .dir-btn {
    flex: 1; padding: 11px 6px; border-radius: 4px; font-family: 'Share Tech Mono', monospace; font-size: 13px;
    border: 1px solid var(--border); background: var(--surface); color: var(--muted); cursor: pointer; transition: all 0.15s; text-align: center;
  }
  .dir-btn.long-btn.selected { background: rgba(0,200,150,0.12); border-color: var(--jade); color: var(--jade); box-shadow: 0 0 12px rgba(0,200,150,0.15); }
  .dir-btn.short-btn.selected { background: rgba(255,45,85,0.12); border-color: var(--neon-red); color: var(--neon-red); box-shadow: 0 0 12px rgba(255,45,85,0.15); }
  .dir-btn.skip-btn.selected { background: rgba(74,85,112,0.2); border-color: var(--muted); color: var(--muted); }

  .amount-row { display: flex; gap: 6px; flex-wrap: wrap; }
  .amt-btn {
    flex: 1; min-width: 58px; padding: 8px 4px; border-radius: 3px; font-family: 'Share Tech Mono', monospace; font-size: 11px;
    border: 1px solid var(--border); background: var(--surface); color: var(--muted); cursor: pointer; transition: all 0.15s; text-align: center;
  }
  .amt-btn.selected { border-color: var(--gold); color: var(--gold); background: rgba(240,165,0,0.08); }

  .submit-section { margin-top: 20px; padding-top: 18px; border-top: 1px solid var(--border); }

  /* Result */
  .result-box { text-align: center; padding: 32px 16px; }
  .result-label { font-family: 'Share Tech Mono', monospace; font-size: 11px; color: var(--muted); letter-spacing: 2px; margin-bottom: 8px; }
  .result-pnl { font-family: 'Bebas Neue', sans-serif; font-size: 72px; }
  .result-pnl.up { color: var(--jade); text-shadow: 0 0 24px rgba(0,200,150,0.4); }
  .result-pnl.down { color: var(--neon-red); text-shadow: 0 0 24px rgba(255,45,85,0.4); }
  .result-total { font-family: 'Share Tech Mono', monospace; font-size: 14px; color: var(--text); margin-top: 8px; }

  /* End */
  .end-box { text-align: center; padding: 40px 20px; }
  .end-title { font-family: 'Bebas Neue', sans-serif; font-size: 48px; color: var(--gold); margin-bottom: 8px; text-shadow: 0 0 24px rgba(240,165,0,0.4); letter-spacing: 4px; }

  .tag { display: inline-block; font-family: 'Share Tech Mono', monospace; font-size: 10px; padding: 2px 8px; border-radius: 2px; letter-spacing: 1px; }
  .tag-live { background: rgba(255,45,85,0.15); color: var(--neon-red); border: 1px solid rgba(255,45,85,0.4); }

  .divider { border: none; border-top: 1px solid var(--border); margin: 18px 0; }
</style>
</head>
<body>

<!-- JOIN SCREEN -->
<div class="screen active" id="screenJoin">
  <div class="join-logo">Market <span>Call</span></div>
  <div class="join-hk">È¶ôÊ∏ØÈáëËûçÂ∏ÇÂ†¥</div>
  <div class="input-group">
    <label class="input-label">YOUR NAME</label>
    <input type="text" id="playerName" placeholder="e.g. Warren Buffett" maxlength="20" />
  </div>
  <button class="btn-full" id="joinBtn" onclick="joinGame()">JOIN GAME</button>
  <p style="font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--muted);margin-top:20px;text-align:center;letter-spacing:1px">You'll start with $10,000 to trade across 4 rounds</p>
</div>

<!-- GAME SCREEN -->
<div class="screen" id="screenGame">
  <div class="status-top">
    <div>
      <div class="player-name" id="displayName">‚Äî</div>
      <div class="capital-label">PORTFOLIO VALUE</div>
    </div>
    <div style="text-align:right">
      <div class="capital-display" id="displayCapital">$10,000</div>
    </div>
  </div>
  <hr class="divider">
  <div id="gameContent"></div>
</div>

<script>
const socket = io();
let myName = '';
let myCapital = 10000;
let votes = {};
let currentMarkets = [];
let timerInterval = null;
let alreadySubmitted = false;

// ‚îÄ‚îÄ Rendering helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function joinGame() {
  const name = document.getElementById('playerName').value.trim();
  if (!name) return;
  myName = name;
  document.getElementById('joinBtn').disabled = true;
  socket.emit('join', { name });
}

socket.on('joined', ({ capital }) => {
  myCapital = capital;
  document.getElementById('displayName').textContent = myName;
  document.getElementById('displayCapital').textContent = '$' + capital.toLocaleString();
  showScreen('screenGame');
});

socket.on('votesReceived', () => {
  const btn = document.getElementById('submitBtn');
  if (btn) { 
    btn.textContent = '‚úì TRADES SUBMITTED'; 
    btn.disabled = true; 
    btn.style.background = '#1e2330'; 
    btn.style.color = 'var(--green)'; 
  }
});

socket.on('roundResult', ({ pnl, totalCapital }) => {
  myCapital = totalCapital;
  document.getElementById('displayCapital').textContent = '$' + totalCapital.toLocaleString();
  const sign = pnl >= 0 ? '+' : '';
  const cls = pnl >= 0 ? 'up' : 'down';
  const emoji = pnl >= 0 ? 'üìà' : 'üìâ';
  document.getElementById('gameContent').innerHTML = `
    <div class="result-box">
      <div style="font-size:48px">${emoji}</div>
      <div class="result-label">ROUND P&L</div>
      <div class="result-pnl ${cls}">${sign}$${Math.abs(pnl).toFixed(0)}</div>
      <div class="result-total">Portfolio: $${totalCapital.toLocaleString()}</div>
      <p style="font-family:'DM Mono',monospace;font-size:12px;color:var(--muted);margin-top:24px">Waiting for host to continue...</p>
    </div>`;
});

socket.on('state', state => {
  renderPhase(state);
});

function renderPhase(state) {
  clearInterval(timerInterval);
  const el = document.getElementById('gameContent');

  if (state.phase === 'lobby') {
    el.innerHTML = `<div class="wait-box"><div class="wait-title">WAITING FOR HOST</div><span class="wait-dot"></span><span class="wait-dot"></span><span class="wait-dot"></span></div>`;
  } else if (state.phase === 'news' && state.round) {
    currentMarkets = state.round.markets;
    el.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
        <span class="tag tag-live">LIVE</span>
        <span style="font-family:'DM Mono',monospace;font-size:11px;color:var(--muted)">ROUND ${state.round.id} / 4</span>
      </div>
      <div class="round-title">${state.round.title}</div>
      <p style="font-size:14px;line-height:1.6;color:#b0b8c8;margin-top:12px">${state.round.news}</p>
      <div style="margin-top:20px;font-family:'DM Mono',monospace;font-size:12px;color:var(--muted)">Host will open voting soon...</div>`;
  } else if (state.phase === 'voting' && state.round) {
    votes = {};
    currentMarkets = state.round.markets;
    // Reset submitted state
    alreadySubmitted = false;
    renderVoting(state);
  } else if (state.phase === 'reveal') {
    // roundResult event handles individual reveal, show generic waiting if no result yet
    if (!document.querySelector('.result-box')) {
      el.innerHTML = `<div class="wait-box"><div class="wait-title">PRICES REVEALED</div><p style="font-family:'DM Mono',monospace;font-size:12px;color:var(--muted);margin-top:12px">Watch the main screen for analysis!</p></div>`;
    }
  } else if (state.phase === 'end') {
    el.innerHTML = `
      <div class="end-box">
        <div class="end-emoji">üèÜ</div>
        <div class="end-title">GAME OVER</div>
        <div style="font-family:'DM Mono',monospace;font-size:14px;color:var(--muted)">Final Portfolio</div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:48px;color:var(--jade);margin-top:4px">$${myCapital.toLocaleString()}</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:13px;color:${myCapital >= 10000 ? 'var(--jade)' : 'var(--neon-red)'};margin-top:8px">
          ${myCapital >= 10000 ? '‚ñ≤' : '‚ñº'} $${Math.abs(myCapital - 10000).toLocaleString()} vs starting capital
        </div>
      </div>`;
  }
}

function renderVoting(state) {
  const AMOUNTS = [500, 1000, 2000, 5000];
  const el = document.getElementById('gameContent');
  const bar = Math.round(((state.timerEnd - Date.now()) / 60000) * 100);

  el.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <div class="round-title" style="font-size:18px">${state.round.title}</div>
      <div id="timerText" style="font-family:'Bebas Neue',sans-serif;font-size:28px;color:var(--green)">60</div>
    </div>
    <div class="timer-bar-wrap"><div class="timer-bar" id="timerBar" style="width:${bar}%"></div></div>
    ${currentMarkets.map(m => `
      <div class="market-section">
        <div class="market-label">${m}</div>
        <div class="direction-btns">
          <div class="dir-btn long-btn" onclick="setDir('${m}','long',this)">üìà LONG</div>
          <div class="dir-btn short-btn" onclick="setDir('${m}','short',this)">üìâ SHORT</div>
          <div class="dir-btn skip-btn selected" onclick="setDir('${m}','skip',this)">‚Äî SKIP</div>
        </div>
        <div class="amount-row" id="amts-${m.replace(/[^a-z0-9]/gi,'_')}">
          ${AMOUNTS.map(a => `<div class="amt-btn" onclick="setAmt('${m}',${a},this)">$${a.toLocaleString()}</div>`).join('')}
        </div>
      </div>`).join('<hr class="divider">')}
    <div class="submit-section">
      <button class="btn-full" id="submitBtn" onclick="submitVotes()">SUBMIT TRADES</button>
    </div>`;

  // Init votes with skip
  currentMarkets.forEach(m => { votes[m] = { direction: 'skip', amount: 0 }; });

  startPlayerTimer(state.timerEnd);
}

function setDir(market, dir, el) {
  const section = el.closest('.market-section');
  section.querySelectorAll('.dir-btn').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
  if (!votes[market]) votes[market] = {};
  votes[market].direction = dir;
  if (dir === 'skip') votes[market].amount = 0;
}

function setAmt(market, amount, el) {
  const key = market.replace(/[^a-z0-9]/gi,'_');
  document.querySelectorAll(`#amts-${key} .amt-btn`).forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
  if (!votes[market]) votes[market] = {};
  votes[market].amount = amount;
}

function submitVotes() {
  if (alreadySubmitted) return;
  const out = {};
  for (const [m, v] of Object.entries(votes)) {
    if (v.direction !== 'skip' && v.amount > 0) out[m] = v;
  }
  socket.emit('submitVotes', { votes: out });
  alreadySubmitted = true;
}

function startPlayerTimer(endTime) {
  timerInterval = setInterval(() => {
    const remaining = Math.max(0, Math.ceil((endTime - Date.now()) / 1000));
    const pct = Math.round((remaining / 60) * 100);
    const timerEl = document.getElementById('timerText');
    const barEl = document.getElementById('timerBar');
    if (timerEl) { timerEl.textContent = remaining; timerEl.style.color = remaining <= 10 ? 'var(--neon-red)' : 'var(--jade)'; }
    if (barEl) { barEl.style.width = pct + '%'; barEl.classList.toggle('urgent', remaining <= 10); }
    if (remaining <= 0) clearInterval(timerInterval);
  }, 200);
}

// Enter to join
document.getElementById('playerName').addEventListener('keydown', e => { if (e.key === 'Enter') joinGame(); });
</script>
</body>
</html>

